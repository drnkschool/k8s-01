---
- name: Install Python dependencies for Kubernetes modules
  ansible.builtin.apt:
    name:
      - python3-pip
      - python3-yaml
      - python3-setuptools
      - python3-kubernetes
    state: present
    update_cache: yes

- name: Add Cilium Helm repository
  kubernetes.core.helm_repository:
    name: "{{ cilium_repo_name }}"
    repo_url: "{{ cilium_repo_url }}"
    kubeconfig: /etc/kubernetes/admin.conf

- name: Update Helm repositories
  ansible.builtin.command: helm repo update
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  changed_when: false

- name: Ensure Cilium namespace exists
  kubernetes.core.k8s:
    kubeconfig: /etc/kubernetes/admin.conf
    api_version: v1
    kind: Namespace
    name: "{{ cilium_namespace }}"
    state: present

- name: Check if Cilium is already installed
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    namespace: "{{ cilium_namespace }}"
    label_selectors:
      - app.kubernetes.io/name=cilium-operator
  register: cilium_check
  ignore_errors: yes

- name: Install/Upgrade Cilium
  kubernetes.core.helm:
    name: "{{ cilium_release }}"
    chart_ref: "{{ cilium_chart_ref }}"
    chart_version: "{{ cilium_chart_version }}"
    release_namespace: "{{ cilium_namespace }}"
    create_namespace: false
    values: "{{ cilium_values }}"
    wait: true
    atomic: true
    timeout: "{{ cilium_timeout }}"
    kubeconfig: /etc/kubernetes/admin.conf
  when: cilium_check.resources | length == 0

- name: Wait for Cilium DaemonSet rollout
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: DaemonSet
    namespace: "{{ cilium_namespace }}"
    name: cilium
  register: cilium_daemonset
  retries: 60
  delay: 10
  until: cilium_daemonset.resources | length > 0 and (cilium_daemonset.resources[0].status.numberReady or 0) > 0

- name: Wait for Cilium Operator rollout
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    namespace: "{{ cilium_namespace }}"
    name: cilium-operator
  register: cilium_operator
  retries: 60
  delay: 10
  until: cilium_operator.resources | length > 0 and (cilium_operator.resources[0].status.readyReplicas or 0) > 0

- name: Show Cilium pods status
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Pod
    namespace: "{{ cilium_namespace }}"
  register: cilium_pods

- name: Display Cilium pods
  ansible.builtin.debug:
    msg: "{{ cilium_pods.resources | map(attribute='metadata.name') | list }}"

