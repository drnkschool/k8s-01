- name: Install cert-manager
  hosts: k8s-01
  become: yes
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
    K8S_AUTH_KUBECONFIG: /etc/kubernetes/admin.conf
  tasks:
    - name: Add Jetstack Helm repository
      kubernetes.core.helm_repository:
        name: jetstack
        repo_url: https://charts.jetstack.io

    - name: Update Helm repositories
      ansible.builtin.shell: helm repo update
      changed_when: false

    - name: Create cert-manager namespace
      kubernetes.core.k8s:
        name: cert-manager
        api_version: v1
        kind: Namespace
        state: present

    - name: Check if cert-manager is already installed
      kubernetes.core.k8s_info:
        api_version: apps/v1
        kind: Deployment
        name: cert-manager
        namespace: cert-manager
      register: certmanager_check
      ignore_errors: yes

    - name: Install cert-manager
      kubernetes.core.helm:
        name: cert-manager
        chart_ref: jetstack/cert-manager
        release_namespace: cert-manager
        values:
          crds:
            enabled: true
        wait: false
      when: certmanager_check.resources | length == 0

