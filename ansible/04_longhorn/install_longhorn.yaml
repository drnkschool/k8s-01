- name: Install Longhorn
  hosts: k8s-01
  become: yes
  tasks:
    - name: Install required packages
      ansible.builtin.apt:
        name:
          - open-iscsi
          - nfs-common
          - jq
        state: present
        update_cache: yes

    - name: Create data directory
      ansible.builtin.file:
        path: /data/slowstorageclass
        state: directory
        mode: '0755'

    - name: Check if Longhorn is already installed
      ansible.builtin.shell: |
        helm list -n longhorn-system -o json 2>/dev/null | jq -r '.[].name' | grep -q "^longhorn$"
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      register: longhorn_check
      ignore_errors: yes
      changed_when: false
      failed_when: false

    - name: Add Longhorn Helm repository
      kubernetes.core.helm_repository:
        name: longhorn
        repo_url: https://charts.longhorn.io
        kubeconfig: /etc/kubernetes/admin.conf

    - name: Update Helm repositories
      ansible.builtin.shell: helm repo update
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf

    - name: Create longhorn-system namespace
      kubernetes.core.k8s:
        name: longhorn-system
        api_version: v1
        kind: Namespace
        state: present
        kubeconfig: /etc/kubernetes/admin.conf

    - name: Install Longhorn with custom values
      kubernetes.core.helm:
        name: longhorn
        chart_ref: longhorn/longhorn
        release_namespace: longhorn-system
        kubeconfig: /etc/kubernetes/admin.conf
        values:
          defaultSettings:
            defaultDataPath: /data/slowstorageclass
          persistence:
            defaultClass: false
        wait: false

    - name: Create custom StorageClass for slow storage
      kubernetes.core.k8s:
        state: present
        kubeconfig: /etc/kubernetes/admin.conf
        definition:
          apiVersion: storage.k8s.io/v1
          kind: StorageClass
          metadata:
            name: longhorn-slow
          provisioner: driver.longhorn.io
          allowVolumeExpansion: true
          reclaimPolicy: Delete
          volumeBindingMode: Immediate
          parameters:
            numberOfReplicas: "3"
            staleReplicaTimeout: "2880"
            fromBackup: ""
            fsType: "ext4"
            dataLocality: "disabled"

